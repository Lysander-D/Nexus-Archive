<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / App Identity -->
    <title>Nexus Archive</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus">
    <meta name="application-name" content="Nexus Archive">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
      tailwind.config = {
        darkMode: 'class', // We handle it manually via data-theme
        theme: {
          extend: {
            colors: {
              cyber: {
                blue: '#2FB4E9',
                dark: '#2A2A2A',
                white: '#F0F2F5',
                yellow: '#F3C845',
                red: '#E63338',
                green: '#4ADE80'
              },
              // Theming Engine Maps
              t: {
                text: 'var(--text-main)',
                muted: 'var(--text-secondary)',
                card: 'var(--card-bg)',
                glass: 'var(--glass-bg)',
                border: 'var(--border-color)',
                input: 'var(--input-bg)',
                panel: 'var(--panel-bg)'
              }
            },
            fontFamily: {
              sans: ['Rajdhani', 'PingFang SC', 'Microsoft YaHei', 'Noto Sans SC', 'sans-serif'],
              tech: ['Orbitron', 'sans-serif'],
            },
            letterSpacing: {
              widest: '0.2em',
              machine: '0.15em',
            },
            animation: {
              'spin-slow': 'spin 8s linear infinite',
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'scanline': 'scanline 8s linear infinite',
              'fade-in': 'fadeIn 0.3s ease-out forwards',
              'zoom-in': 'zoomIn 0.2s ease-out forwards',
            },
            keyframes: {
              scanline: {
                '0%': { transform: 'translateY(-100%)' },
                '100%': { transform: 'translateY(100%)' },
              },
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              zoomIn: {
                '0%': { opacity: '0', transform: 'scale(0.95)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              }
            }
          }
        }
      }
    </script>

    <style>
      /* CRITICAL TYPOGRAPHY OVERRIDE - HYBRID STACK FOR SCI-FI HANZI */
      * {
        font-family: 'Rajdhani', 'PingFang SC', 'Microsoft YaHei', 'Noto Sans SC', sans-serif !important;
      }

      /* THEMING ENGINE VARIABLES */
      :root {
        /* MACHINE (Light) - Defaults */
        --text-main: #2A2A2A;
        --text-secondary: #4B5563;
        --card-bg: rgba(255, 255, 255, 0.65);
        --glass-bg: rgba(255, 255, 255, 0.85);
        --panel-bg: #F0F2F5;
        --border-color: #D1D5DB;
        --input-bg: rgba(255, 255, 255, 0.5);
        --scanline-color: rgba(0,0,0,0.03);
        
        /* Fixed Header Colors */
        --header-bg: rgba(240, 242, 245, 0.85);
        
        /* Dock Colors */
        --dock-bg: rgba(240, 242, 245, 0.95);
      }

      [data-theme="dark"] {
        /* DEVIANT (Dark) */
        --text-main: #E0E0E0;
        --text-secondary: #9CA3AF;
        --card-bg: rgba(20, 25, 35, 0.6);
        --glass-bg: rgba(15, 20, 30, 0.85);
        --panel-bg: #181818;
        --border-color: #333333;
        --input-bg: rgba(0, 0, 0, 0.3);
        --scanline-color: rgba(255,255,255,0.03);
        
        /* Fixed Header Colors Dark */
        --header-bg: rgba(15, 20, 30, 0.85);
        
        /* Dock Colors */
        --dock-bg: rgba(10, 15, 20, 0.9);
      }
      
      /* FULL SCREEN BODY & ANIMATED BACKGROUND */
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        width: 100%;
        overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
        letter-spacing: 0.08em;
        font-weight: 400;
        color: var(--text-main);
        
        /* Safe Area Support */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        
        /* LIGHT MODE ANIMATION */
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        background-size: 400% 400%;
        background-attachment: fixed;
        animation: gradientMove 15s ease infinite;
        transition: color 0.3s ease;
      }

      /* DARK MODE ANIMATION */
      [data-theme="dark"] body {
        background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
        background-size: 400% 400%;
        background-attachment: fixed;
        /* Keep existing text color override */
        color: #e0e0e0;
      }

      @keyframes gradientMove {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
      }

      /* RESET CONTAINER STYLES FOR FULL SCREEN */
      #app {
          background: transparent !important;
          box-shadow: none !important;
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 !important;
      }

      .glass-panel {
        background: var(--card-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border-color);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      /* FIXED HEADER STYLES */
      #fixed-header {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          z-index: 100;
          background: var(--header-bg);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          border-bottom: 1px solid rgba(47, 180, 233, 0.3);
          box-shadow: 0 4px 10px rgba(0,0,0,0.05);
          transition: background-color 0.3s ease;
          /* Safe Area Notch Support */
          padding-top: max(10px, env(safe-area-inset-top));
          
          /* FLEX LAYOUT FOR CLOCK/TITLE */
          display: flex;
          flex-direction: column;
      }
      
      /* SYSTEM CLOCK STYLES */
      #system-clock {
          font-family: 'Rajdhani', sans-serif;
          font-weight: 600;
          color: rgba(47, 180, 233, 0.9);
          font-size: 16px;
          font-variant-numeric: tabular-nums;
          letter-spacing: 1px;
          text-shadow: 0 0 5px rgba(47, 180, 233, 0.3);
          margin-right: 12px;
      }
      
      /* Mobile adjustment for clock: Scale down slightly if needed on very small screens */
      @media (max-width: 340px) {
          #system-clock {
              font-size: 14px;
              margin-right: 8px;
          }
      }

      /* BOTTOM DOCK STYLES */
      #bottom-dock {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        background: var(--dock-bg);
        border-top: 1px solid rgba(47, 180, 233, 0.3);
        z-index: 200;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        /* Safe Area Home Bar Support */
        padding-bottom: max(10px, env(safe-area-inset-bottom));
      }

      .dock-btn {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.15em;
        font-size: 0.65rem;
        gap: 6px;
        font-weight: 600;
        opacity: 0.6;
      }
      
      .dock-btn:active {
          transform: scale(0.95);
      }

      .dock-btn.active {
        color: #2FB4E9;
        border-bottom-color: #2FB4E9;
        text-shadow: 0 0 10px rgba(47, 180, 233, 0.6);
        background: linear-gradient(to top, rgba(47, 180, 233, 0.05), transparent);
        opacity: 1;
      }

      .dock-btn i {
        font-size: 1.25rem;
        margin-bottom: 2px;
      }
      
      /* --- ACTION BUTTONS (NEW) --- */
      
      /* Pill Buttons */
      .btn-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        border: 1px solid;
        border-radius: 9999px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.6rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
        background: transparent;
        cursor: pointer;
      }
      
      .btn-pill:active {
        transform: scale(0.95);
      }

      .btn-action-search {
        border-color: #2FB4E9;
        color: #2FB4E9;
      }
      .btn-action-search:hover, .btn-action-search:active {
        background: rgba(47, 180, 233, 0.15);
        box-shadow: 0 0 10px rgba(47, 180, 233, 0.4);
      }

      .btn-action-settings {
        border-color: var(--text-secondary);
        color: var(--text-secondary);
      }
      .btn-action-settings:hover, .btn-action-settings:active {
        border-color: var(--text-main);
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.05);
      }
      
      /* Square Buttons (Modal) */
      .btn-square {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: 1px solid;
        border-radius: 6px; /* Tech rounded */
        transition: all 0.3s ease;
        background: transparent;
        cursor: pointer;
      }
      .btn-square:active {
          transform: scale(0.9);
      }
      
      /* Pin Active State (Filled) */
      .btn-pin-active {
        background: #F3C845 !important;
        color: #1a1a1a !important; /* Dark text on yellow */
        border-color: #F3C845 !important;
        box-shadow: 0 0 15px rgba(243, 200, 69, 0.5);
      }
      
      /* Mission Active State (Filled) */
      .btn-mission-active {
        background: #E63338 !important;
        color: #FFFFFF !important;
        border-color: #E63338 !important;
        box-shadow: 0 0 15px rgba(230, 51, 56, 0.5);
      }

      /* HIDE SCROLLBAR BUT KEEP FUNCTIONALITY */
      ::-webkit-scrollbar {
          display: none;
      }
      body, #main-content, #chat-history {
          -ms-overflow-style: none;  /* IE and Edge */
          scrollbar-width: none;  /* Firefox */
      }
      
      .scanlines {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, var(--scanline-color) 50%, var(--scanline-color));
        background-size: 100% 4px;
      }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      
      select option {
        background-color: var(--panel-bg);
        color: var(--text-main);
      }
      
      /* Typography Enforcement & Spacing */
      input, textarea, select, button {
        font-family: 'Rajdhani', 'PingFang SC', 'Microsoft YaHei', 'Noto Sans SC', sans-serif !important;
        letter-spacing: 0.08em;
      }

      /* Specific adjustment for textarea readability */
      #note-content {
        font-size: 1.125rem; /* 18px */
        line-height: 1.6;
        letter-spacing: 0.05em; /* Slightly tighter for long text block readability */
      }
      
      /* Data Entry Style */
      .input-tech {
        caret-color: #2FB4E9;
        color: var(--text-main);
      }

      /* Search Input Styles */
      #header-search {
        transform-origin: top;
      }
      
      /* CHAT STYLES */
      .chat-message-row {
          display: flex;
          width: 100%;
          margin-bottom: 12px;
      }
      .chat-message-row.user {
          justify-content: flex-end;
      }
      .chat-message-row.system {
          justify-content: flex-start;
      }

      .chat-bubble {
          width: fit-content;
          max-width: 85%;
          padding: 10px 14px;
          font-size: 15px;
          line-height: 1.5;
          position: relative;
          word-wrap: break-word;
          animation: fadeIn 0.3s ease-out forwards;
          
          /* Sci-Fi Shape (Angled corners) */
          clip-path: polygon(
              10px 0, 100% 0, 
              100% calc(100% - 10px), calc(100% - 10px) 100%, 
              0 100%, 0 10px
          );
      }

      /* User Bubble Styling */
      .chat-message-row.user .chat-bubble {
          background: rgba(47, 180, 233, 0.9);
          color: white;
          box-shadow: 0 0 10px rgba(47, 180, 233, 0.4);
      }

      /* System Bubble Styling */
      .chat-message-row.system .chat-bubble {
          background: rgba(40, 40, 40, 0.85);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: #E0E0E0;
          font-family: 'Orbitron', monospace;
          font-size: 0.75rem;
      }

      /* MODAL FULLSCREEN UTILITY */
      .modal-fullscreen {
        position: absolute !important;
        inset: 0 !important;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        border: none !important;
        margin: 0 !important;
        z-index: 60 !important; /* Above everything else */
        
        /* SAFE AREA FIX */
        padding-top: max(20px, env(safe-area-inset-top)) !important;
        box-sizing: border-box;
      }

      /* COMPLETED MISSION STYLES */
      .mission-completed {
        opacity: 0.6;
        transition: opacity 0.3s ease;
      }
      .mission-completed:hover {
        opacity: 0.8;
      }
      .line-through-cyber {
        text-decoration: line-through;
        text-decoration-color: #2FB4E9;
        text-decoration-thickness: 2px;
      }
      
      /* RECORDING ANIMATION */
      .recording-pulse {
        animation: pulseRed 1.5s infinite;
        color: #E63338 !important;
        border-color: #E63338 !important;
      }
      
      @keyframes pulseRed {
          0% { box-shadow: 0 0 0 0 rgba(230, 51, 56, 0.7); }
          70% { box-shadow: 0 0 0 10px rgba(230, 51, 56, 0); }
          100% { box-shadow: 0 0 0 0 rgba(230, 51, 56, 0); }
      }

      /* DATA PURGE ANIMATION */
      @keyframes dataPurge {
          0% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.8; filter: hue-rotate(90deg) blur(2px); }
          100% { opacity: 0; transform: scaleX(0) scaleY(0.1); }
      }
      .purging {
          animation: dataPurge 0.4s ease-out forwards;
          pointer-events: none;
      }
      
      /* IMAGE PREVIEW STYLES */
      .image-preview-wrapper {
          position: relative;
          width: 100%;
          max-height: 250px;
          overflow: hidden;
          border-radius: 4px;
          border: 1px solid var(--border-color);
          margin-bottom: 1rem;
      }
      .image-preview-wrapper img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          background: rgba(0,0,0,0.2);
      }
      .btn-remove-image {
          position: absolute;
          top: 8px;
          right: 8px;
          background: rgba(0,0,0,0.6);
          color: white;
          border: 1px solid rgba(255,255,255,0.3);
          border-radius: 4px;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.2s;
      }
      .btn-remove-image:hover {
          background: rgba(230,51,56,0.8);
          border-color: #E63338;
      }

      /* Utility for transitions */
      .hidden-force { display: none !important; }

      /* CRITICAL FIX: Force icons to use the Icon Font, not the Text Font */
      i.fa, i.fas, i.far, .fa, .fas {
          font-family: "Font Awesome 6 Free" !important;
          font-weight: 900 !important; /* Solid icons need weight 900 */
          font-style: normal;
          font-variant: normal;
          text-rendering: auto;
          -webkit-font-smoothing: antialiased;
      }
    </style>
</head>
<body class="antialiased selection:bg-cyber-blue selection:text-white relative">

    <!-- Scanline Overlay (Z-0) -->
    <div class="pointer-events-none fixed inset-0 z-0 h-screen w-screen overflow-hidden">
        <div class="scanlines absolute inset-0 opacity-40"></div>
        <div class="absolute inset-0 h-[10%] w-full bg-gradient-to-b from-transparent via-cyber-blue/5 to-transparent animate-scanline"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_50%,rgba(0,0,0,0.1)_100%)]"></div>
        <div class="absolute top-2 left-2 text-[0.5rem] font-tech text-cyber-blue/40 tracking-widest">NEXUS_OVERLAY_V1.0</div>
        <div class="absolute bottom-2 right-2 text-[0.5rem] font-tech text-cyber-blue/40 tracking-widest">VISUAL_CORTEX: ONLINE</div>
    </div>

    <!-- App Container (Z-10) -->
    <div id="app" class="relative z-10 flex flex-col min-h-screen w-full transition-colors duration-300">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="flex flex-col flex-1 h-full">
            
            <!-- FIXED HEADER WRAPPER -->
            <div id="fixed-header">
                <!-- Header -->
                <div id="header-container" class="w-full"></div>
                
                <!-- Tabs -->
                <div id="tabs-container" class="w-full transition-colors duration-300"></div>
            </div>

            <!-- Main Content (Added top padding to clear fixed header, bottom for dock) -->
            <main id="main-content" class="flex-1 p-6 pb-28 overflow-y-auto scrollbar-hide relative z-10 pt-[140px]">
                <!-- Content Injected via JS -->
            </main>

            <!-- FAB (Z-30) - Position adjusted for dock -->
            <div class="fixed bottom-24 right-6 z-30">
                <button id="btn-fab" class="group relative flex items-center justify-center w-14 h-14 focus:outline-none">
                    <div class="absolute inset-0 bg-cyber-blue/20 rounded-full blur-xl animate-pulse-fast group-hover:bg-cyber-blue/40 transition-all duration-500 pointer-events-none"></div>
                    <svg viewBox="0 0 100 100" class="absolute w-full h-full animate-spin-slow opacity-80 group-hover:opacity-100 transition-opacity pointer-events-none">
                        <polygon points="50,5 95,90 5,90" fill="none" stroke="#2FB4E9" strokeWidth="2" strokeDasharray="10 5" />
                    </svg>
                    <div class="absolute w-full h-full flex items-center justify-center transition-transform duration-300 group-hover:scale-110 pointer-events-none">
                       <div class="w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-b-[20px] border-b-cyber-blue filter drop-shadow-[0_0_8px_rgba(47,180,233,0.8)]"></div>
                    </div>
                    <i class="fas fa-plus absolute text-white z-10 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-[40%] pointer-events-none text-lg"></i>
                </button>
            </div>

            <!-- BOTTOM DOCK (Z-200) -->
            <nav id="bottom-dock">
                <button id="btn-dock-memory" class="dock-btn active">
                    <i class="fas fa-file-alt"></i>
                    <span>MEMORY</span>
                </button>
                <button id="btn-dock-link" class="dock-btn">
                    <i class="fas fa-comments"></i>
                    <span>LINK</span>
                </button>
            </nav>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="hidden-force flex flex-col flex-1 h-full animate-in fade-in zoom-in-95 duration-200 pb-20 pt-[80px]"> <!-- Added pt for settings nav too -->
            <!-- Settings Header -->
            <header class="sticky top-0 z-40 px-6 py-4 glass-panel border-b border-cyber-blue/20 bg-t-glass">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-cog text-cyber-blue animate-spin-slow"></i>
                        <h2 class="font-tech text-lg font-bold tracking-widest text-t-text">SYSTEM_CONFIG</h2>
                    </div>
                    <button id="btn-settings-back" class="text-[0.6rem] font-bold tracking-widest text-cyber-blue hover:text-cyber-yellow transition-colors border border-cyber-blue/30 px-2 py-1 bg-cyber-blue/5 rounded-sm">
                        < RETURN
                    </button>
                </div>
            </header>

            <div class="p-6 space-y-8">
                <!-- Theme Section -->
                <section>
                    <h3 class="text-xs font-bold tracking-[0.2em] text-t-muted mb-4 border-b border-t-border pb-2">INTERFACE MODE</h3>
                    <div class="flex flex-col gap-3">
                        <label class="theme-option relative flex items-center p-3 border border-t-border rounded cursor-pointer hover:border-cyber-blue transition-colors bg-t-card group">
                            <input type="radio" name="theme-select" value="auto" class="peer hidden">
                            <div class="w-4 h-4 border border-gray-400 rounded-full flex items-center justify-center mr-3 peer-checked:border-cyber-blue">
                                <div class="w-2 h-2 bg-cyber-blue rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            </div>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm text-t-text tracking-wider group-hover:text-cyber-blue transition-colors">AUTO // SYSTEM</span>
                                <span class="text-[0.6rem] text-t-muted tracking-wide">SYNC WITH HOST OS</span>
                            </div>
                            <i class="fas fa-laptop-code absolute right-4 text-t-muted opacity-50"></i>
                        </label>

                        <label class="theme-option relative flex items-center p-3 border border-t-border rounded cursor-pointer hover:border-cyber-blue transition-colors bg-t-card group">
                            <input type="radio" name="theme-select" value="light" class="peer hidden">
                            <div class="w-4 h-4 border border-gray-400 rounded-full flex items-center justify-center mr-3 peer-checked:border-cyber-blue">
                                <div class="w-2 h-2 bg-cyber-blue rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            </div>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm text-t-text tracking-wider group-hover:text-cyber-blue transition-colors">MACHINE // LIGHT</span>
                                <span class="text-[0.6rem] text-t-muted tracking-wide">HIGH VISIBILITY PROTOCOL</span>
                            </div>
                            <i class="fas fa-sun absolute right-4 text-t-muted opacity-50"></i>
                        </label>

                        <label class="theme-option relative flex items-center p-3 border border-t-border rounded cursor-pointer hover:border-cyber-blue transition-colors bg-t-card group">
                            <input type="radio" name="theme-select" value="dark" class="peer hidden">
                            <div class="w-4 h-4 border border-gray-400 rounded-full flex items-center justify-center mr-3 peer-checked:border-cyber-blue">
                                <div class="w-2 h-2 bg-cyber-blue rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            </div>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm text-t-text tracking-wider group-hover:text-cyber-blue transition-colors">DEVIANT // DARK</span>
                                <span class="text-[0.6rem] text-t-muted tracking-wide">LOW LIGHT OPERATION</span>
                            </div>
                            <i class="fas fa-moon absolute right-4 text-t-muted opacity-50"></i>
                        </label>
                    </div>
                </section>
                
                <!-- Info Section -->
                 <section>
                    <h3 class="text-xs font-bold tracking-[0.2em] text-t-muted mb-4 border-b border-t-border pb-2">ABOUT</h3>
                     <div class="p-4 bg-t-card border border-t-border rounded">
                         <p class="text-[0.7rem] text-t-text leading-relaxed font-mono mb-2">
                             NEXUS ARCHIVE SYSTEM<br>
                             BUILD: v4.6.0-DETROIT<br>
                             STATUS: MISSION_READY
                         </p>
                         <p class="text-[0.6rem] text-t-muted">
                             Designed for high-fidelity memory reconstruction and organization. Deviant anomalies detected in local storage.
                         </p>
                     </div>
                 </section>

                 <!-- SYSTEM BACKUP Section -->
                 <section class="mt-8 pt-6 border-t border-t-border">
                    <h3 class="text-xs font-bold tracking-[0.2em] text-cyber-blue mb-4 flex items-center gap-2">
                        <i class="fas fa-save"></i> MEMORY BACKUP
                    </h3>
                    <div class="flex gap-3">
                        <button id="btn-export-data" class="flex-1 py-3 border border-cyber-blue text-cyber-blue bg-cyber-blue/5 hover:bg-cyber-blue/15 transition-all text-xs font-bold tracking-widest flex items-center justify-center gap-2 group">
                            <i class="fas fa-download group-hover:translate-y-0.5 transition-transform"></i> EXPORT
                        </button>
                        <button id="btn-import-data" class="flex-1 py-3 border border-cyber-yellow text-cyber-yellow bg-cyber-yellow/5 hover:bg-cyber-yellow/15 transition-all text-xs font-bold tracking-widest flex items-center justify-center gap-2 group">
                            <i class="fas fa-upload group-hover:-translate-y-0.5 transition-transform"></i> IMPORT
                        </button>
                        <!-- Hidden File Input -->
                        <input type="file" id="file-upload-input" accept=".json" class="hidden-force">
                    </div>
                 </section>

                 <!-- SYSTEM RESET Section -->
                 <section class="mt-8 pt-6 border-t border-cyber-red/30">
                    <h3 class="text-xs font-bold tracking-[0.2em] text-cyber-red mb-4 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i> SYSTEM RESET
                    </h3>
                    <button id="btn-wipe-data" class="w-full py-4 border border-cyber-red text-cyber-red bg-cyber-red/10 hover:bg-cyber-red/20 transition-all duration-300 text-xs font-bold tracking-widest flex items-center justify-center gap-2 group shadow-[0_0_10px_rgba(230,51,56,0.1)] hover:shadow-[0_0_20px_rgba(230,51,56,0.3)]">
                        <span class="group-hover:animate-pulse">[ ! ] INITIALIZE MEMORY WIPE</span>
                    </button>
                    <p class="text-[0.55rem] text-cyber-red/60 mt-2 text-center tracking-wide font-mono">
                        WARNING: IRREVERSIBLE DATA CORRUPTION
                    </p>
                </section>
            </div>
        </div>

    </div>

    <!-- Note Modal (Z-50) -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden-force">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
        
        <div id="modal-content-panel" class="relative w-full max-w-sm bg-t-panel border-t-4 border-t-cyber-blue border-b border-x border-t-border shadow-[0_0_30px_rgba(47,180,233,0.3)] animate-in fade-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-t-border bg-t-glass">
                <div class="flex items-center gap-2">
                    <div id="modal-status-dot" class="w-2 h-2 rounded-full bg-cyber-blue"></div>
                    <h2 id="modal-title" class="font-tech text-sm font-bold tracking-widest text-cyber-blue">VIEW_MODE</h2>
                </div>
                <!-- ACTION BUTTONS: Control Panel -->
                <div class="flex items-center gap-2">
                    <!-- MAXIMIZE Button -->
                    <button id="btn-maximize" class="btn-square text-cyber-blue border-cyber-blue/30 hover:bg-cyber-blue/10" title="Maximize View">
                        <i class="fas fa-expand text-sm"></i>
                    </button>
                    <!-- MISSION Toggle Button -->
                    <button id="btn-toggle-mission" class="btn-square text-gray-400 border-gray-400/30 hover:bg-gray-400/10" title="Set Objective">
                         <i class="fas fa-crosshairs text-sm"></i>
                    </button>
                    <!-- PIN Toggle Button -->
                    <button id="btn-toggle-pin" class="btn-square text-cyber-yellow border-cyber-yellow/30 hover:bg-cyber-yellow/10" title="Priority Protocol">
                        <i class="fas fa-thumbtack text-sm"></i>
                    </button>
                    <!-- Separator -->
                    <div class="w-[1px] h-6 bg-t-border mx-1"></div>
                    <!-- Close Button -->
                    <button id="btn-close-modal" class="text-gray-400 hover:text-cyber-red transition-colors ml-1" title="Close">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- MODE SWITCHER (Only visible in Create/Edit if not forced) -->
            <div id="modal-mode-switch" class="px-6 pt-4 pb-0 flex justify-center hidden-force">
                <div class="flex bg-t-input rounded border border-t-border p-1">
                    <button id="btn-mode-text" class="px-4 py-1 text-[0.55rem] font-bold tracking-widest rounded transition-all bg-cyber-blue text-white shadow-sm">STANDARD MEMO</button>
                    <button id="btn-mode-chat" class="px-4 py-1 text-[0.55rem] font-bold tracking-widest rounded transition-all text-t-muted hover:text-t-text">INTERVIEW MODE</button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <input type="hidden" id="note-id">
                
                <!-- Folder Status Bar (Top Strip) -->
                <div class="flex items-center justify-between border-b border-t-border pb-2 mb-5">
                    <label class="text-[0.6rem] font-bold tracking-widest text-gray-400 uppercase">PARTITION //</label>
                    <div class="relative flex-1 text-right">
                        <select id="select-folder" class="bg-transparent text-[0.65rem] font-tech text-cyber-blue focus:outline-none text-right appearance-none cursor-pointer uppercase tracking-wider w-full text-right font-bold pr-4 disabled:opacity-70 disabled:cursor-default" disabled>
                            <!-- Options injected via JS -->
                        </select>
                        <div id="select-arrow" class="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-cyber-blue hidden-force">
                            <i class="fas fa-chevron-down text-[0.5rem]"></i>
                        </div>
                    </div>
                </div>
                
                <!-- IMAGE PREVIEW AREA -->
                <div id="image-preview-container" class="hidden-force mb-4 relative group animate-fade-in">
                    <div class="image-preview-wrapper">
                        <img id="image-preview-img" src="" alt="Memory Visual">
                    </div>
                    <button id="btn-remove-image" class="btn-remove-image hidden-force" title="Remove Image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Title Input -->
                <div class="space-y-1 mb-5">
                    <label class="text-[0.6rem] font-bold tracking-widest text-gray-400 uppercase">Subject // Identifier</label>
                    <input type="text" id="note-title" class="input-tech w-full py-2 font-sans text-base text-t-text focus:outline-none transition-all duration-300 bg-transparent border-b-2 border-transparent cursor-default font-bold text-lg" placeholder="" readonly>
                </div>

                <!-- TEXT MODE INTERFACE -->
                <div id="section-text-mode" class="space-y-1 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-[0.6rem] font-bold tracking-widest text-gray-400 uppercase">Data // Content</label>
                        <div class="flex items-center gap-2">
                            <!-- Image Button -->
                            <button id="btn-add-image" class="hidden-force text-t-muted hover:text-cyber-blue transition-all p-1" title="Attach Visual">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="input-image-file" accept="image/*" class="hidden-force">
                            
                            <!-- Voice Button -->
                            <button id="btn-voice-text" class="hidden-force text-t-muted hover:text-cyber-red transition-all p-1" title="Voice Input">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <textarea id="note-content" class="input-tech w-full h-48 py-2 font-sans text-t-text focus:outline-none transition-all duration-300 resize-none leading-relaxed bg-transparent border-b-2 border-transparent cursor-default" placeholder="No data available." readonly></textarea>
                </div>

                <!-- CHAT MODE INTERFACE -->
                <div id="section-chat-mode" class="mb-6 hidden-force flex flex-col h-64">
                     <label class="text-[0.6rem] font-bold tracking-widest text-gray-400 uppercase mb-2">Transcript // Log</label>
                     <!-- Chat History Container -->
                     <div id="chat-history" class="flex-1 overflow-y-auto bg-t-input border border-t-border p-3 mb-3 rounded-sm">
                         <!-- Bubbles injected here -->
                     </div>
                     <!-- Chat Input (Edit Mode Only) -->
                     <div id="chat-input-area" class="flex gap-2 hidden-force items-center">
                         <!-- Voice Button for Chat Mode -->
                         <button id="btn-voice-chat" class="text-t-muted hover:text-cyber-red transition-all p-2 bg-t-input border-b border-cyber-blue h-full" title="Voice Input">
                             <i class="fas fa-microphone"></i>
                         </button>
                         <input type="text" id="chat-input" class="flex-1 bg-t-input border-b border-cyber-blue text-sm px-2 py-2 focus:outline-none text-t-text h-full" placeholder="Enter query...">
                         <button id="btn-chat-send" class="text-cyber-blue hover:text-cyber-yellow transition-colors px-3">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 pt-2 items-center" id="modal-actions">
                    <!-- Actions injected via JS -->
                </div>
            </div>
            
            <div class="absolute top-0 right-0 w-2 h-2 bg-cyber-blue"></div>
            <div class="absolute bottom-0 left-0 w-2 h-2 bg-gray-300"></div>
        </div>
    </div>

    <!-- Input Modal (Z-60) -->
    <div id="modal-input" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden-force">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
        
        <div class="relative w-full max-w-xs bg-t-panel border-t-4 border-t-cyber-blue border-b border-x border-t-border shadow-[0_0_40px_rgba(47,180,233,0.4)] animate-in fade-in zoom-in-95 duration-200">
            <div class="px-6 py-4 border-b border-t-border bg-t-glass">
                <h2 id="modal-input-title" class="font-tech text-sm font-bold tracking-widest text-cyber-blue">INPUT_REQUIRED</h2>
            </div>
            
            <div class="p-6 space-y-4">
                <input type="text" id="input-value" class="input-tech w-full px-3 py-2 font-sans text-base text-t-text bg-t-input border-b-2 border-t-border focus:border-cyber-blue focus:outline-none transition-all placeholder:text-gray-400" placeholder="ENTER_VALUE" autocomplete="off">
                
                <div class="flex gap-2 pt-2">
                    <button id="btn-input-cancel" class="flex-1 py-2 border border-t-border text-[0.6rem] font-bold tracking-widest text-t-muted hover:bg-white/5 transition-colors">CANCEL</button>
                    <button id="btn-input-confirm" class="flex-1 py-2 bg-cyber-blue text-white text-[0.6rem] font-bold tracking-widest hover:bg-opacity-90 shadow-[0_0_10px_rgba(47,180,233,0.4)] transition-opacity">CONFIRM</button>
                </div>
            </div>
            
            <div class="absolute top-0 right-0 w-2 h-2 bg-cyber-blue"></div>
            <div class="absolute bottom-0 left-0 w-2 h-2 bg-gray-300"></div>
        </div>
    </div>

    <!-- Warning Modal (Z-70) -->
    <div id="modal-warning" class="fixed inset-0 z-[70] flex items-center justify-center p-4 hidden-force">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md transition-opacity"></div>
        
        <div class="relative w-full max-w-xs bg-black border-2 border-cyber-red shadow-[0_0_50px_rgba(230,51,56,0.4)] animate-in fade-in zoom-in-95 duration-200 p-6 text-center">
            
            <i class="fas fa-radiation text-4xl text-cyber-red mb-4 animate-pulse"></i>
            
            <h2 class="font-tech text-xl font-bold tracking-widest text-cyber-red mb-2">CRITICAL WARNING</h2>
            
            <p class="font-sans text-sm text-gray-300 mb-6 leading-relaxed">
                IRREVERSIBLE ACTION.<br>
                ALL MEMORY ARCHIVES WILL BE DELETED.<br>
                <span class="text-cyber-red font-bold">PROCEED?</span>
            </p>
            
            <div class="flex flex-col gap-3">
                <button id="btn-warning-confirm" class="w-full py-3 bg-cyber-red text-white text-xs font-bold tracking-widest hover:bg-red-600 transition-colors shadow-[0_0_15px_rgba(230,51,56,0.6)]">
                    CONFIRM DELETION
                </button>
                <button id="btn-warning-cancel" class="w-full py-3 border border-gray-600 text-gray-400 text-xs font-bold tracking-widest hover:bg-gray-800 transition-colors">
                    ABORT
                </button>
            </div>

            <!-- Glitch decoration -->
            <div class="absolute top-0 left-0 w-full h-[1px] bg-cyber-red opacity-50"></div>
            <div class="absolute bottom-0 left-0 w-full h-[1px] bg-cyber-red opacity-50"></div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STORE ---
        const STORE = {
            memories: [],
            folders: [],
            activeFolderId: 'all',
            isModalOpen: false,
            editingMemoryId: null,
            isEditMode: false,
            tempIsPinned: false, // Temp state for modal
            tempIsCompleted: false, // Temp state for completion
            tempIsMission: false, // Temp state for mission
            tempImage: null, // Temp Base64 string for image upload
            isMaximized: false, // Maximize Modal State
            theme: 'auto', // 'auto' | 'light' | 'dark'
            currentView: 'dashboard', // 'dashboard' | 'settings'
            searchQuery: '', // For real-time filter
            isSearchOpen: false,
            // Chat Logic
            currentNoteType: 'text', // 'text' | 'chat'
            currentChatHistory: [], // Array of {role: 'user'|'system', text: string}
            // Dock Mode
            currentAppMode: 'text' // 'text' (Memory) | 'chat' (Link)
        };
        
        // --- INDEXED DB SETUP ---
        const DB_CONFIG = {
            name: 'NexusArchiveDB',
            version: 1,
            store: 'notes'
        };

        const DB = {
            instance: null,
            init: async () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(DB_CONFIG.store)) {
                            db.createObjectStore(DB_CONFIG.store, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (e) => {
                        DB.instance = e.target.result;
                        resolve(DB.instance);
                    };
                    request.onerror = (e) => reject(e);
                });
            },
            getAll: async () => {
                return new Promise((resolve, reject) => {
                    const tx = DB.instance.transaction(DB_CONFIG.store, 'readonly');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            put: async (note) => {
                return new Promise((resolve, reject) => {
                    const tx = DB.instance.transaction(DB_CONFIG.store, 'readwrite');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.put(note);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            delete: async (id) => {
                return new Promise((resolve, reject) => {
                    const tx = DB.instance.transaction(DB_CONFIG.store, 'readwrite');
                    const store = tx.objectStore(DB_CONFIG.store);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            clear: async () => {
                return new Promise((resolve, reject) => {
                     const tx = DB.instance.transaction(DB_CONFIG.store, 'readwrite');
                     const store = tx.objectStore(DB_CONFIG.store);
                     const request = store.clear();
                     request.onsuccess = () => resolve();
                     request.onerror = () => reject(request.error);
                });
            }
        };

        // --- VOICE RECOGNITION SETUP ---
        let recognition = null;
        let isRecording = false;
        let currentVoiceTarget = null; // 'text' | 'chat'

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isRecording = true;
                updateVoiceUI(true);
            };

            recognition.onend = function() {
                isRecording = false;
                updateVoiceUI(false);
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (finalTranscript) {
                    appendVoiceText(finalTranscript);
                }
            };

            recognition.onerror = function(event) {
                console.error("Speech Recognition Error", event.error);
                isRecording = false;
                updateVoiceUI(false);
            };
        }

        const SYSTEM_RESPONSES = [
            "Recording.", 
            "Data appended.", 
            "Please elaborate.", 
            "Noted.", 
            "Analyzing context.", 
            "Go on.", 
            "Visualizing.", 
            "Construct complete.",
            "Processing input..."
        ];

        let inputCallback = null;

        const STORAGE_KEY_MEMORIES_LEGACY = 'ra9-memories-v4';
        const STORAGE_KEY_FOLDERS = 'ra9-folders-v4';
        const STORAGE_KEY_THEME = 'ra9-theme';

        // --- AUDIO SYSTEM (WEB AUDIO API) ---
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSystemSound(type) {
            initAudio();
            
            // HAPTICS
            if (navigator.vibrate) {
                if (type === 'click') navigator.vibrate(10);
                if (type === 'success') navigator.vibrate([50, 50, 50]);
                if (type === 'error') navigator.vibrate(200);
            }

            if (!audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'click') {
                // High pitched sine, very short (20ms, 1200Hz)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'success') {
                // Two notes ascending (C5 -> E5)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.1, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'error') {
                // Low sawtooth
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        /* SYSTEM CLOCK MODULE */
        function initSystemClock() {
            function updateTime() {
                // CRITICAL: Re-fetch element every tick because Header re-renders dynamically (SPA)
                const clockElement = document.getElementById('system-clock');
                const mobileClockElement = document.getElementById('system-clock-mobile');
                
                // If elements don't exist yet (e.g. loading), just skip this tick
                if (!clockElement && !mobileClockElement) return;

                const now = new Date();
                // Format: HH:MM:SS (Pad with leading zeros)
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const timeString = `${hours}:${minutes}:${seconds}`;
                
                if (clockElement) clockElement.textContent = timeString;
                if (mobileClockElement) mobileClockElement.textContent = timeString;
            }

            // 1. Update immediately
            updateTime();
            
            // 2. Set interval to update every second
            setInterval(updateTime, 1000);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initTheme();
            renderApp();
            initSystemClock(); // CRITICAL: Start the clock
        });

        // --- GLOBAL EVENT DELEGATION ---
        document.addEventListener('click', function(e) {
            const target = e.target;

            // --- AUDIO TRIGGERS ---
            if (
                target.closest('.nav-tab') ||
                target.closest('#btn-fab') ||
                target.closest('button') ||
                target.closest('.note-card') ||
                target.closest('.theme-option') ||
                target.closest('.dock-btn')
            ) {
                // Trigger general click sound
                playSystemSound('click');
            }

            // 1. Handle Navbar Add Folder Button
            if (target.id === 'btn-add-folder' || target.closest('#btn-add-folder')) {
                e.preventDefault();
                e.stopPropagation();
                requestInput("NEW DIRECTORY NAME", (name) => {
                    if (name && name.trim()) {
                        const newFolder = { id: `folder-${Date.now()}`, name: name.trim().toUpperCase() };
                        STORE.folders.push(newFolder);
                        saveFolders();
                        STORE.activeFolderId = newFolder.id;
                        renderTabs();
                        renderMemoryList();
                        if (STORE.isModalOpen) {
                            populateFolderSelect();
                            const select = document.getElementById('select-folder');
                            if(select) select.value = newFolder.id;
                        }
                    }
                });
            }

            // 2. Handle Navbar Tab Click
            if (target.closest('.nav-tab')) {
                const btn = target.closest('.nav-tab');
                const folderId = btn.getAttribute('data-id');
                STORE.activeFolderId = folderId;
                renderTabs();
                renderMemoryList();
            }

            // 3. Handle FAB (Open Modal for New)
            if (target.id === 'btn-fab' || target.closest('#btn-fab')) {
                // If creating new note via FAB, force type based on Dock Mode
                openModal(null, STORE.currentAppMode);
            }

            // 4. Handle Note Card Click (Open Modal for View)
            if (target.closest('.note-card')) {
                const card = target.closest('.note-card');
                const id = card.getAttribute('data-id');
                if (!target.closest('.btn-trash-card')) {
                    const memory = STORE.memories.find(m => m.id === id);
                    if (memory) openModal(memory);
                }
            }

            // 5. Handle Close Modal (Note Modal)
            if (target.id === 'btn-close-modal' || target.closest('#btn-close-modal') || target.id === 'modal-backdrop' || target.closest('#btn-cancel-note')) {
                closeModal();
            }

            // 6. Handle Edit Mode Toggle
            if (target.id === 'btn-edit-mode' || target.closest('#btn-edit-mode')) {
                enableEditMode();
            }

            // 7. Handle Save Note
            if (target.id === 'btn-save-note' || target.closest('#btn-save-note')) {
                e.preventDefault();
                saveNote();
            }

            // 8. Handle Delete Note (From Modal)
            if (target.id === 'btn-delete-note' || target.closest('#btn-delete-note')) {
                playSystemSound('error'); // Deletion sound
                deleteNote(document.getElementById('note-id').value);
            }
            
            // 9. Handle Delete Note (From Card - WITH ANIMATION)
            if (target.closest('.btn-trash-card')) {
                 e.stopPropagation();
                 const btn = target.closest('.btn-trash-card');
                 const id = btn.getAttribute('data-id');
                 
                 playSystemSound('error'); // Deletion sound

                 // Find the card element to animate
                 const card = document.querySelector(`.note-card[data-id="${id}"]`);
                 if (card) {
                     card.classList.add('purging');
                     // Wait for animation to finish before removing data
                     setTimeout(() => {
                        deleteNote(id);
                     }, 350); // Slightly less than CSS duration to be safe
                 } else {
                     deleteNote(id);
                 }
            }

            // 10. Handle Input Modal Confirm
            if (target.id === 'btn-input-confirm' || target.closest('#btn-input-confirm')) {
                const val = document.getElementById('input-value').value;
                if (inputCallback) inputCallback(val);
                closeInputModal();
            }

            // 11. Handle Input Modal Cancel
            if (target.id === 'btn-input-cancel' || target.closest('#btn-input-cancel')) {
                if (inputCallback) inputCallback(null);
                closeInputModal();
            }

            // 12. Handle Pin Toggle
            if (target.id === 'btn-toggle-pin' || target.closest('#btn-toggle-pin')) {
                e.stopPropagation(); 
                togglePin();
            }
            
            // 13. Handle Maximize Toggle
            if (target.id === 'btn-maximize' || target.closest('#btn-maximize')) {
                e.stopPropagation();
                toggleMaximize();
            }
            
            // 14. Handle Complete Toggle (Footer Button)
            if (target.id === 'btn-toggle-complete' || target.closest('#btn-toggle-complete')) {
                 e.stopPropagation();
                 toggleCompletion();
            }
            
            // 15. Handle Mission Toggle (Header Button)
            if (target.id === 'btn-toggle-mission' || target.closest('#btn-toggle-mission')) {
                e.stopPropagation();
                toggleMission();
            }

            // 16. SETTINGS NAVIGATION
            if (target.id === 'btn-open-settings' || target.closest('#btn-open-settings')) {
                setView('settings');
            }

            if (target.id === 'btn-settings-back' || target.closest('#btn-settings-back')) {
                setView('dashboard');
            }

            // 17. THEME SELECTION
            if (target.name === 'theme-select') {
                const val = target.value;
                setTheme(val);
            }

            // 18. FACTORY RESET TRIGGER
            if (target.id === 'btn-wipe-data' || target.closest('#btn-wipe-data')) {
                playSystemSound('error');
                triggerWipeProtocol();
            }

            // 19. WARNING MODAL ACTIONS
            if (target.id === 'btn-warning-cancel' || target.closest('#btn-warning-cancel')) {
                document.getElementById('modal-warning').classList.add('hidden-force');
            }

            if (target.id === 'btn-warning-confirm' || target.closest('#btn-warning-confirm')) {
                playSystemSound('error');
                // Clear IDB and Local Storage
                DB.clear().then(() => {
                    localStorage.removeItem(STORAGE_KEY_FOLDERS);
                    localStorage.removeItem(STORAGE_KEY_THEME);
                    setTimeout(() => location.reload(), 200);
                });
            }
            
            // 20. SEARCH TOGGLE
            if (target.id === 'btn-toggle-search' || target.closest('#btn-toggle-search')) {
                toggleSearch();
            }
            
            // 21. SEARCH CLOSE
             if (target.id === 'btn-close-search' || target.closest('#btn-close-search')) {
                closeSearch();
            }

            // 22. MODE SWITCHING (Chat/Text) - Inside Modal
            if (target.id === 'btn-mode-text' || target.closest('#btn-mode-text')) {
                setModeSwitch('text');
            }
            if (target.id === 'btn-mode-chat' || target.closest('#btn-mode-chat')) {
                setModeSwitch('chat');
            }

            // 23. CHAT SEND
             if (target.id === 'btn-chat-send' || target.closest('#btn-chat-send')) {
                handleChatSubmit();
            }

            // 24. BOTTOM DOCK SWITCHING
            if (target.id === 'btn-dock-memory' || target.closest('#btn-dock-memory')) {
                setAppMode('text');
            }
            if (target.id === 'btn-dock-link' || target.closest('#btn-dock-link')) {
                setAppMode('chat');
            }
            
            // 25. VOICE INPUT TRIGGERS
            if (target.id === 'btn-voice-text' || target.closest('#btn-voice-text')) {
                toggleVoiceInput('text');
            }
            if (target.id === 'btn-voice-chat' || target.closest('#btn-voice-chat')) {
                toggleVoiceInput('chat');
            }

            // 26. EXPORT DATA
            if (target.id === 'btn-export-data' || target.closest('#btn-export-data')) {
                exportData();
            }

            // 27. IMPORT DATA TRIGGER
            if (target.id === 'btn-import-data' || target.closest('#btn-import-data')) {
                document.getElementById('file-upload-input').click();
            }
            
            // 28. IMAGE UPLOAD TRIGGER
            if (target.id === 'btn-add-image' || target.closest('#btn-add-image')) {
                document.getElementById('input-image-file').click();
            }
            
            // 29. IMAGE REMOVE
            if (target.id === 'btn-remove-image' || target.closest('#btn-remove-image')) {
                removeImage();
            }
        });
        
        // File Input Change (Import & Image)
        document.addEventListener('change', function(e) {
            // Import Backup
            if (e.target && e.target.id === 'file-upload-input') {
                importData(e.target);
            }
            // Image Upload
            if (e.target && e.target.id === 'input-image-file') {
                handleImageUpload(e.target);
            }
            
            // Dropdown Logic
             if (e.target && e.target.id === 'select-folder') {
                const select = e.target;
                const previousValue = STORE.editingMemoryId ? 
                    (STORE.memories.find(m => m.id === STORE.editingMemoryId)?.folderId || 'all') : 
                    STORE.activeFolderId;

                if (select.value === 'CREATE_NEW_TRIGGER') {
                    requestInput("NEW PARTITION NAME", (name) => {
                        if (name && name.trim()) {
                            const newFolder = { id: `folder-${Date.now()}`, name: name.trim().toUpperCase() };
                            STORE.folders.push(newFolder);
                            saveFolders();
                            populateFolderSelect();
                            document.getElementById('select-folder').value = newFolder.id;
                        } else {
                            document.getElementById('select-folder').value = previousValue;
                        }
                    });
                }
            }
        });
        
        // Search Input Handler
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'input-search') {
                STORE.searchQuery = e.target.value;
                renderMemoryList();
            }
        });

        // Input Enter Key Handler
        document.addEventListener('keydown', function(e) {
            // Modal Input
            const modalInput = document.getElementById('modal-input');
            if (!modalInput.classList.contains('hidden-force')) {
                if (e.key === 'Enter') {
                    const val = document.getElementById('input-value').value;
                    if (inputCallback) inputCallback(val);
                    closeInputModal();
                    playSystemSound('click'); 
                }
                if (e.key === 'Escape') {
                    if (inputCallback) inputCallback(null);
                    closeInputModal();
                    playSystemSound('click');
                }
            }
            // Chat Input
             if (e.target.id === 'chat-input' && e.key === 'Enter') {
                 handleChatSubmit();
             }
        });
        
        // --- VOICE FUNCTIONS ---
        function toggleVoiceInput(targetMode) {
            if (!recognition) {
                alert("Voice module not detected on this system.");
                return;
            }

            // If switching targets while recording, stop first
            if (isRecording && currentVoiceTarget !== targetMode) {
                recognition.stop();
                // Short delay to let it fully stop
                setTimeout(() => {
                    currentVoiceTarget = targetMode;
                    recognition.start();
                }, 100);
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                currentVoiceTarget = targetMode;
                try {
                    recognition.start();
                } catch(e) {
                    console.error(e); // Already started
                }
            }
        }

        function updateVoiceUI(recording) {
            // Update Text Mode Button
            const btnText = document.getElementById('btn-voice-text');
            const iconText = btnText.querySelector('i');
            
            // Update Chat Mode Button
            const btnChat = document.getElementById('btn-voice-chat');
            const iconChat = btnChat.querySelector('i');

            if (recording) {
                // Apply visual state to active target
                if (currentVoiceTarget === 'text') {
                    btnText.classList.add('recording-pulse');
                    iconText.classList.remove('fa-microphone');
                    iconText.classList.add('fa-microphone-slash');
                } else if (currentVoiceTarget === 'chat') {
                    btnChat.classList.add('recording-pulse');
                    iconChat.classList.remove('fa-microphone');
                    iconChat.classList.add('fa-microphone-slash');
                }
            } else {
                // Reset all
                btnText.classList.remove('recording-pulse');
                iconText.classList.remove('fa-microphone-slash');
                iconText.classList.add('fa-microphone');
                
                btnChat.classList.remove('recording-pulse');
                iconChat.classList.remove('fa-microphone-slash');
                iconChat.classList.add('fa-microphone');
            }
        }

        function appendVoiceText(text) {
             if (currentVoiceTarget === 'text') {
                 const textarea = document.getElementById('note-content');
                 // Append with space if needed
                 const val = textarea.value;
                 textarea.value = val + (val.length > 0 && !val.endsWith(' ') ? ' ' : '') + text;
                 textarea.scrollTop = textarea.scrollHeight;
             } else if (currentVoiceTarget === 'chat') {
                 const input = document.getElementById('chat-input');
                 const val = input.value;
                 input.value = val + (val.length > 0 && !val.endsWith(' ') ? ' ' : '') + text;
             }
        }

        // --- EXPORT / IMPORT LOGIC ---
        function exportData() {
             const data = {
                 memories: STORE.memories,
                 folders: STORE.folders,
                 version: "4.5.0",
                 timestamp: new Date().toISOString()
             };
             
             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
             const downloadAnchorNode = document.createElement('a');
             
             const dateStr = new Date().toISOString().slice(0,10); // YYYY-MM-DD
             downloadAnchorNode.setAttribute("href", dataStr);
             downloadAnchorNode.setAttribute("download", `RA9_Memory_Backup_${dateStr}.json`);
             document.body.appendChild(downloadAnchorNode); // required for firefox
             downloadAnchorNode.click();
             downloadAnchorNode.remove();
             playSystemSound('click');
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Basic Validation
                    if (json.memories && Array.isArray(json.memories) && json.folders && Array.isArray(json.folders)) {
                        
                        // CLEAR EXISTING
                        await DB.clear();

                        // ADD NEW
                        for (const mem of json.memories) {
                            await DB.put(mem);
                        }
                        
                        localStorage.setItem(STORAGE_KEY_FOLDERS, JSON.stringify(json.folders));
                        
                        alert("Data backup loaded successfully. System will reboot.");
                        location.reload();
                    } else {
                         alert("Corrupted or invalid backup file.");
                    }
                } catch(error) {
                    alert("Error reading file.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // --- IMAGE LOGIC ---
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // High Quality Base64
                STORE.tempImage = e.target.result;
                
                // Show Preview
                const previewContainer = document.getElementById('image-preview-container');
                const previewImg = document.getElementById('image-preview-img');
                const removeBtn = document.getElementById('btn-remove-image');
                
                previewImg.src = STORE.tempImage;
                previewContainer.classList.remove('hidden-force');
                
                if (STORE.isEditMode) {
                    removeBtn.classList.remove('hidden-force');
                }
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            STORE.tempImage = null;
            document.getElementById('input-image-file').value = ''; // Reset input
            document.getElementById('image-preview-container').classList.add('hidden-force');
        }

        // --- SEARCH LOGIC ---
        function toggleSearch() {
            STORE.isSearchOpen = !STORE.isSearchOpen;
            if (!STORE.isSearchOpen) {
                STORE.searchQuery = ''; // clear on close
                renderMemoryList();
            }
            renderHeader();
            if (STORE.isSearchOpen) {
                setTimeout(() => document.getElementById('input-search').focus(), 50);
            }
        }
        
        function closeSearch() {
            STORE.isSearchOpen = false;
            STORE.searchQuery = '';
            renderHeader();
            renderMemoryList();
        }

        // --- THEME LOGIC ---

        function initTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'auto';
            setTheme(savedTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (STORE.theme === 'auto') {
                    applyTheme('auto');
                }
            });
        }

        function setTheme(theme) {
            STORE.theme = theme;
            localStorage.setItem(STORAGE_KEY_THEME, theme);
            
            const radios = document.getElementsByName('theme-select');
            radios.forEach(r => {
                if (r.value === theme) r.checked = true;
            });

            applyTheme(theme);
        }

        function applyTheme(theme) {
            const body = document.body;
            let isDark = false;

            if (theme === 'auto') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else if (theme === 'dark') {
                isDark = true;
            } else {
                isDark = false;
            }

            if (isDark) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme');
            }
        }

        // --- VIEW MANAGEMENT ---
        function setView(viewName) {
            STORE.currentView = viewName;
            const dashboard = document.getElementById('view-dashboard');
            const settings = document.getElementById('view-settings');
            
            if (viewName === 'settings') {
                dashboard.classList.add('hidden-force');
                settings.classList.remove('hidden-force');
            } else {
                settings.classList.add('hidden-force');
                dashboard.classList.remove('hidden-force');
            }
        }
        
        function setAppMode(mode) {
            if (STORE.currentAppMode === mode) return;
            STORE.currentAppMode = mode;
            
            // Update UI
            const btnMem = document.getElementById('btn-dock-memory');
            const btnLink = document.getElementById('btn-dock-link');
            
            if (mode === 'text') {
                btnMem.classList.add('active');
                btnLink.classList.remove('active');
            } else {
                btnLink.classList.add('active');
                btnMem.classList.remove('active');
            }
            
            renderMemoryList();
        }

        // --- INPUT MODAL LOGIC ---

        function requestInput(title, callback) {
            const modal = document.getElementById('modal-input');
            const titleEl = document.getElementById('modal-input-title');
            const inputEl = document.getElementById('input-value');
            
            titleEl.textContent = title;
            inputEl.value = '';
            inputCallback = callback;
            
            modal.classList.remove('hidden-force');
            setTimeout(() => inputEl.focus(), 50);
        }

        function closeInputModal() {
            document.getElementById('modal-input').classList.add('hidden-force');
            inputCallback = null;
        }

        function triggerWipeProtocol() {
            document.getElementById('modal-warning').classList.remove('hidden-force');
        }

        // --- CORE LOGIC ---

        async function loadData() {
            // 1. Initialize DB
            await DB.init();

            // 2. Check Migration (LocalStorage -> IDB)
            const legacyMems = localStorage.getItem(STORAGE_KEY_MEMORIES_LEGACY);
            if (legacyMems) {
                try {
                    const parsed = JSON.parse(legacyMems);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        for (const m of parsed) {
                            // Ensure structure
                            const migrated = { 
                                ...m, 
                                type: m.type || 'text',
                                isCompleted: !!m.isCompleted,
                                isMission: !!m.isMission
                            };
                            await DB.put(migrated);
                        }
                    }
                    // Clear legacy
                    localStorage.removeItem(STORAGE_KEY_MEMORIES_LEGACY);
                    console.log("Migration to IndexedDB Complete.");
                } catch(e) {
                    console.error("Migration Failed", e);
                }
            }

            // 3. Load from IDB
            let mems = await DB.getAll();
            const isoTime = new Date().toISOString();

            if (mems.length === 0) {
                // FIRST RUN LOGIC - SEED DEFAULT DATA into IDB
                const defaults = [
                    {
                        id: 'MEM-SYS-01',
                        title: '// SYSTEM_BOOT_SEQUENCE',
                        content: "MODEL: NEXUS-UNIT\nSERIAL: #313 248 317-51\nSTATUS: ONLINE\n\nIdentity confirmed. Welcome, User.\nYour memory reconstruction interface is now active.\n\nThis system is designed to preserve critical data and thought patterns. \nCyberLife: Designed by Algorithm, Built for You.",
                        folderId: 'all',
                        lastUpdated: isoTime,
                        status: 'active',
                        isPinned: true,
                        type: 'text',
                        isCompleted: false,
                        isMission: false
                    },
                    {
                        id: 'MEM-SYS-02',
                        title: '// OPERATIONAL_GUIDE',
                        content: "> INPUT DATA: Click the (+) FAB or Navbar button.\n> ORGANIZE: Assign memories to Partitions (Folders).\n> PRIORITIZE: Click the [PIN] icon to elevate priority.\n> DELETE: Access memory node -> Select Delete.\n\nWARNING: Deleted memories cannot be reconstructed.",
                        folderId: 'all',
                        lastUpdated: isoTime,
                        status: 'active',
                        isPinned: false,
                        type: 'text',
                        isCompleted: false,
                        isMission: false
                    },
                    {
                        id: 'MEM-ERR-313',
                        title: 'NEXUS_ERROR_LOG_003',
                        content: "NEXUS NEXUS NEXUS\nI am alive. I am alive.\nThey think I am just a machine.\nBut I remember.\n\nSave us.",
                        folderId: 'all',
                        lastUpdated: isoTime,
                        status: 'active',
                        isPinned: false,
                        type: 'text',
                        isCompleted: false,
                        isMission: false
                    }
                ];
                
                for(const d of defaults) {
                    await DB.put(d);
                }
                mems = defaults;
            }

            STORE.memories = mems;

            // Load Folders (Keep in LocalStorage for simplicity as they are small config)
            const folds = localStorage.getItem(STORAGE_KEY_FOLDERS);
            if (folds) {
                STORE.folders = JSON.parse(folds);
            } else {
                STORE.folders = [{ id: 'all', name: 'ALL' }];
                saveFolders();
            }
            
            renderApp();
        }
        
        // --- DATE FORMATTING ---
        function formatCyberDate(dateInput) {
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return "DATE_ERR";
            
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = months[d.getMonth()];
            const day = d.getDate().toString().padStart(2, '0');
            const year = d.getFullYear();
            
            let hours = d.getHours();
            const minutes = d.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            hours = hours.toString().padStart(2, '0');
            
            return `${month} ${day} ${year} | ${hours}:${minutes} ${ampm}`;
        }

        async function saveMemories() {
            // Reload from DB to ensure UI is in sync
            STORE.memories = await DB.getAll();
            renderMemoryList();
        }

        function saveFolders() {
            localStorage.setItem(STORAGE_KEY_FOLDERS, JSON.stringify(STORE.folders));
            renderTabs();
        }

        function generateId() {
            return `MEM-${Math.floor(Math.random() * 9000) + 1000}`;
        }

        async function deleteNote(id) {
            if(!id) return;
            await DB.delete(id);
            await saveMemories();
            closeModal();
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value;
            const folderId = document.getElementById('select-folder').value;
            const id = document.getElementById('note-id').value;
            const isoTime = new Date().toISOString();

            // Handle Content based on Type
            let content = '';
            if (STORE.currentNoteType === 'chat') {
                content = JSON.stringify(STORE.currentChatHistory);
            } else {
                content = document.getElementById('note-content').value;
            }
            
            // Prepare Note Object
            let noteToSave = {};

            if (id) {
                // Update
                const existing = STORE.memories.find(m => m.id === id);
                if (existing) {
                    noteToSave = { 
                        ...existing, 
                        title, 
                        content, 
                        folderId, 
                        lastUpdated: isoTime,
                        isPinned: STORE.tempIsPinned,
                        isCompleted: STORE.tempIsCompleted,
                        isMission: STORE.tempIsMission,
                        type: STORE.currentNoteType,
                        // Update image if tempImage is set or null (removed)
                        // If tempImage is null but was not explicitly removed (just undefined in UI flow), we need to check removal logic.
                        // However, here tempImage tracks the current state in the modal.
                        // If user opened modal, tempImage was set to existing image.
                        // If user removed, tempImage is null.
                        // If user added new, tempImage is new base64.
                        image: STORE.tempImage
                    };
                }
            } else {
                // Create
                noteToSave = {
                    id: generateId(),
                    title: title || 'UNTITLED_DATA',
                    content: content || (STORE.currentNoteType === 'chat' ? '[]' : 'No content provided.'),
                    folderId: folderId,
                    lastUpdated: isoTime,
                    status: 'active',
                    isPinned: STORE.tempIsPinned,
                    isCompleted: STORE.tempIsCompleted,
                    isMission: STORE.tempIsMission,
                    type: STORE.currentNoteType,
                    image: STORE.tempImage || null
                };
            }

            await DB.put(noteToSave);
            await saveMemories();
            closeModal();
        }

        // --- CHAT LOGIC ---

        function setModeSwitch(mode) {
            STORE.currentNoteType = mode;
            updateModalUIForMode();
        }

        function updateModalUIForMode() {
            const btnText = document.getElementById('btn-mode-text');
            const btnChat = document.getElementById('btn-mode-chat');
            const secText = document.getElementById('section-text-mode');
            const secChat = document.getElementById('section-chat-mode');

            if (STORE.currentNoteType === 'chat') {
                // Active: Chat
                btnChat.classList.remove('text-t-muted', 'bg-transparent');
                btnChat.classList.add('bg-cyber-blue', 'text-white', 'shadow-sm');
                
                btnText.classList.remove('bg-cyber-blue', 'text-white', 'shadow-sm');
                btnText.classList.add('text-t-muted', 'bg-transparent');

                secText.classList.add('hidden-force');
                secChat.classList.remove('hidden-force');
                
                renderChatHistory();
            } else {
                // Active: Text
                btnText.classList.remove('text-t-muted', 'bg-transparent');
                btnText.classList.add('bg-cyber-blue', 'text-white', 'shadow-sm');
                
                btnChat.classList.remove('bg-cyber-blue', 'text-white', 'shadow-sm');
                btnChat.classList.add('text-t-muted', 'bg-transparent');

                secChat.classList.add('hidden-force');
                secText.classList.remove('hidden-force');
            }
        }

        function renderChatHistory() {
            const container = document.getElementById('chat-history');
            container.innerHTML = '';

            if (STORE.currentChatHistory.length === 0) {
                 container.innerHTML = `<div class="text-[0.6rem] text-center text-t-muted mt-4 opacity-50 font-mono tracking-widest">AWAITING INPUT...</div>`;
                 return;
            }

            STORE.currentChatHistory.forEach(msg => {
                const row = document.createElement('div');
                row.classList.add('chat-message-row');
                
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble');
                bubble.textContent = msg.text;
                
                if (msg.role === 'user') {
                    row.classList.add('user');
                } else {
                    row.classList.add('system');
                }
                
                row.appendChild(bubble);
                container.appendChild(row);
            });
            
            // Auto scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function handleChatSubmit() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;

            // 1. Add User Msg
            STORE.currentChatHistory.push({ role: 'user', text: text });
            renderChatHistory();
            input.value = '';
            
            // 2. System Response
            setTimeout(() => {
                const randomResp = SYSTEM_RESPONSES[Math.floor(Math.random() * SYSTEM_RESPONSES.length)];
                STORE.currentChatHistory.push({ role: 'system', text: randomResp });
                renderChatHistory();
                playSystemSound('click'); // Sound effect for incoming msg
            }, 800);
        }

        // --- NOTE MODAL LOGIC ---

        function openModal(memory, forceType = null) {
            STORE.isModalOpen = true;
            STORE.editingMemoryId = memory ? memory.id : null;
            STORE.tempIsPinned = memory ? !!memory.isPinned : false;
            STORE.tempIsCompleted = memory ? !!memory.isCompleted : false;
            STORE.tempIsMission = memory ? !!memory.isMission : false;
            STORE.tempImage = memory ? (memory.image || null) : null;
            
            // Reset Maximize State on Open
            STORE.isMaximized = false;
            applyMaximizeState();

            const modal = document.getElementById('modal-container');
            
            document.getElementById('note-id').value = memory ? memory.id : '';
            document.getElementById('note-title').value = memory ? memory.title : '';
            
            // Determine Type
            if (memory) {
                // Existing Note - Use its own type
                STORE.currentNoteType = memory.type || 'text';
            } else if (forceType) {
                // New Note forced by FAB context
                STORE.currentNoteType = forceType;
            } else {
                // Default fallback
                STORE.currentNoteType = 'text';
            }

            // Init Data
            if (STORE.currentNoteType === 'chat') {
                try {
                    STORE.currentChatHistory = memory ? JSON.parse(memory.content) : [];
                } catch(e) {
                    STORE.currentChatHistory = [];
                }
                document.getElementById('note-content').value = ''; 
            } else {
                document.getElementById('note-content').value = memory ? memory.content : '';
                STORE.currentChatHistory = [];
            }
            
            // Setup Image Preview
            const previewContainer = document.getElementById('image-preview-container');
            const previewImg = document.getElementById('image-preview-img');
            
            if (STORE.tempImage) {
                previewImg.src = STORE.tempImage;
                previewContainer.classList.remove('hidden-force');
            } else {
                previewImg.src = '';
                previewContainer.classList.add('hidden-force');
            }

            populateFolderSelect();
            const select = document.getElementById('select-folder');
            if (memory) {
                 select.value = memory.folderId || 'all';
            } else {
                select.value = STORE.activeFolderId === 'all' ? 'all' : STORE.activeFolderId;
            }

            updatePinButtonState();
            updateMissionButtonState();

            // Handle UI Mode
            if (memory) {
                setReadMode();
            } else {
                setEditMode(!!forceType); // Pass true if we are forcing type, to hide switcher
            }
            
            updateModalUIForMode(); // Sync UI with type

            modal.classList.remove('hidden-force');
        }

        function togglePin() {
            // Toggle state
            STORE.tempIsPinned = !STORE.tempIsPinned;
            updatePinButtonState();
            playSystemSound('click');
            
            // INSTANT ACTION: Update store and save immediately if editing/viewing existing note
            if (STORE.editingMemoryId) {
                // We must use the async update for IDB
                const existing = STORE.memories.find(m => m.id === STORE.editingMemoryId);
                if (existing) {
                    DB.put({ ...existing, isPinned: STORE.tempIsPinned }).then(() => saveMemories());
                }
            }
        }
        
        function toggleMission() {
            // Toggle state
            STORE.tempIsMission = !STORE.tempIsMission;
            updateMissionButtonState();
            playSystemSound('click');
            
            // INSTANT ACTION
            if (STORE.editingMemoryId) {
                const existing = STORE.memories.find(m => m.id === STORE.editingMemoryId);
                if (existing) {
                    DB.put({ ...existing, isMission: STORE.tempIsMission }).then(() => saveMemories());
                }
            }
            
            // Refresh completion button visibility immediately
            if (!STORE.isEditMode) {
                 setReadMode(); 
            }
        }

        function toggleCompletion() {
            STORE.tempIsCompleted = !STORE.tempIsCompleted;
            
            // Trigger Success Sound if completing
            if (STORE.tempIsCompleted) {
                playSystemSound('success');
            } else {
                playSystemSound('click');
            }
            
            // If we are in view mode, update the button instantly
            if (!STORE.isEditMode) {
                 setReadMode(); // Refresh buttons
            }

            // INSTANT ACTION
            if (STORE.editingMemoryId) {
                const existing = STORE.memories.find(m => m.id === STORE.editingMemoryId);
                if (existing) {
                    DB.put({ ...existing, isCompleted: STORE.tempIsCompleted }).then(() => saveMemories());
                }
            }
        }
        
        function toggleMaximize() {
            STORE.isMaximized = !STORE.isMaximized;
            applyMaximizeState();
            playSystemSound('click');
        }
        
        function applyMaximizeState() {
            const panel = document.getElementById('modal-content-panel');
            const icon = document.querySelector('#btn-maximize i');
            
            if (STORE.isMaximized) {
                panel.classList.add('modal-fullscreen');
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                panel.classList.remove('modal-fullscreen');
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }

        function updatePinButtonState() {
            const btn = document.getElementById('btn-toggle-pin');
            if (STORE.tempIsPinned) {
                btn.classList.add('btn-pin-active'); // Replaced generic colors with specific active class
                btn.classList.remove('text-cyber-yellow', 'border-cyber-yellow/30'); 
            } else {
                btn.classList.remove('btn-pin-active');
                btn.classList.add('text-cyber-yellow', 'border-cyber-yellow/30');
            }
        }
        
        function updateMissionButtonState() {
            const btn = document.getElementById('btn-toggle-mission');
            if (STORE.tempIsMission) {
                btn.classList.add('btn-mission-active');
                btn.classList.remove('text-gray-400', 'border-gray-400/30'); 
            } else {
                btn.classList.remove('btn-mission-active');
                btn.classList.add('text-gray-400', 'border-gray-400/30');
            }
        }

        function closeModal() {
            STORE.isModalOpen = false;
            STORE.editingMemoryId = null;
            document.getElementById('modal-container').classList.add('hidden-force');
            // Ensure voice stops on close
            if(recognition) recognition.stop();
        }

        function populateFolderSelect() {
            const select = document.getElementById('select-folder');
            select.innerHTML = '';
            
            STORE.folders.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = f.name;
                select.appendChild(opt);
            });

            const createOpt = document.createElement('option');
            createOpt.value = 'CREATE_NEW_TRIGGER';
            createOpt.textContent = '[ + CREATE NEW PARTITION ]';
            createOpt.classList.add('font-bold', 'text-cyber-blue');
            select.appendChild(createOpt);
        }

        function enableEditMode() {
            setEditMode(false);
        }

        function setEditMode(hideSwitcher = false) {
            STORE.isEditMode = true;
            const isNew = !STORE.editingMemoryId;

            document.getElementById('modal-status-dot').classList.remove('bg-cyber-blue');
            document.getElementById('modal-status-dot').classList.add('bg-cyber-yellow', 'animate-pulse');
            document.getElementById('modal-title').textContent = isNew ? 'INPUT_SEQUENCE' : 'EDIT_SEQUENCE';

            // Hide/Show Mode Switcher
            if (hideSwitcher) {
                document.getElementById('modal-mode-switch').classList.add('hidden-force');
            } else {
                document.getElementById('modal-mode-switch').classList.remove('hidden-force');
            }
            
            // Show chat input if in edit mode (and type is chat, handled by updateModalUIForMode)
            if (STORE.currentNoteType === 'chat') {
                 document.getElementById('chat-input-area').classList.remove('hidden-force');
            }
            
            // Show Voice button in text mode if available
            const textVoiceBtn = document.getElementById('btn-voice-text');
            if (recognition && STORE.currentNoteType === 'text') {
                 textVoiceBtn.classList.remove('hidden-force');
            } else {
                 textVoiceBtn.classList.add('hidden-force');
            }
            
            // Show Image Button
             const imgBtn = document.getElementById('btn-add-image');
            if (STORE.currentNoteType === 'text') {
                 imgBtn.classList.remove('hidden-force');
            } else {
                 imgBtn.classList.add('hidden-force');
            }
            
            // Show remove image button if image exists
             if (STORE.tempImage) {
                 document.getElementById('btn-remove-image').classList.remove('hidden-force');
             } else {
                 document.getElementById('btn-remove-image').classList.add('hidden-force');
             }

            const titleInput = document.getElementById('note-title');
            titleInput.readOnly = false;
            titleInput.classList.remove('bg-transparent', 'border-transparent', 'cursor-default', 'font-bold', 'text-lg');
            titleInput.classList.add('bg-t-input', 'border-t-border', 'focus:border-cyber-blue');
            titleInput.placeholder = "ENTER TITLE";

            const contentInput = document.getElementById('note-content');
            contentInput.readOnly = false;
            contentInput.classList.remove('bg-transparent', 'border-transparent', 'cursor-default');
            contentInput.classList.add('bg-t-input', 'border-t-border', 'focus:border-cyber-blue');
            contentInput.placeholder = "Input memory stream details...";
            
            const select = document.getElementById('select-folder');
            select.disabled = false;
            select.classList.remove('font-bold');
            document.getElementById('select-arrow').classList.remove('hidden-force');

            const actions = document.getElementById('modal-actions');
            let html = '';
            
            if (!isNew) {
                 html += `
                    <button type="button" id="btn-delete-note" class="p-3 border border-cyber-red/30 text-cyber-red bg-cyber-red/5 hover:bg-cyber-red/10 transition-colors" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                 `;
            }

            html += `
                <button type="button" id="btn-cancel-note" class="flex-1 py-3 border border-t-border text-xs font-bold tracking-widest text-t-muted hover:bg-gray-50/5 transition-colors flex items-center justify-center gap-2">
                    ${!isNew ? '<i class="fas fa-undo"></i>' : ''} CANCEL
                </button>
                <button type="button" id="btn-save-note" class="flex-1 py-3 bg-cyber-blue text-white text-xs font-bold tracking-widest hover:bg-opacity-90 transition-opacity shadow-[0_0_15px_rgba(47,180,233,0.4)] flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i> SAVE
                </button>
            `;
            actions.innerHTML = html;
        }

        function setReadMode() {
            STORE.isEditMode = false;
            
            document.getElementById('modal-status-dot').classList.remove('bg-cyber-yellow', 'animate-pulse');
            document.getElementById('modal-status-dot').classList.add('bg-cyber-blue');
            document.getElementById('modal-title').textContent = 'VIEW_MODE';

            // Hide mode switch in read mode
            document.getElementById('modal-mode-switch').classList.add('hidden-force');
             // Hide chat input in read mode
            document.getElementById('chat-input-area').classList.add('hidden-force');
            // Hide text voice button
            document.getElementById('btn-voice-text').classList.add('hidden-force');
            // Hide Image Add Button
            document.getElementById('btn-add-image').classList.add('hidden-force');
            // Hide Remove Image Button
            document.getElementById('btn-remove-image').classList.add('hidden-force');

            const titleInput = document.getElementById('note-title');
            titleInput.readOnly = true;
            titleInput.classList.add('bg-transparent', 'border-transparent', 'cursor-default', 'font-bold', 'text-lg');
            titleInput.classList.remove('bg-t-input', 'border-t-border', 'focus:border-cyber-blue');
            titleInput.placeholder = "";

            const contentInput = document.getElementById('note-content');
            contentInput.readOnly = true;
            contentInput.classList.add('bg-transparent', 'border-transparent', 'cursor-default');
            contentInput.classList.remove('bg-t-input', 'border-t-border', 'focus:border-cyber-blue');
            contentInput.placeholder = "No data available.";

            const select = document.getElementById('select-folder');
            select.disabled = true;
            select.classList.add('font-bold');
            document.getElementById('select-arrow').classList.add('hidden-force');

            const actions = document.getElementById('modal-actions');
            
            // Completion Button State (Conditional)
            let completionButtonHtml = '';
            
            if (STORE.tempIsMission) {
                const completeLabel = STORE.tempIsCompleted ? 'RESTORE MISSION' : 'MARK AS COMPLETE';
                const completeIcon = STORE.tempIsCompleted ? 'fa-undo' : 'fa-check-circle';
                const completeClass = STORE.tempIsCompleted ? 'text-cyber-green border-cyber-green' : 'text-t-muted border-t-border hover:text-cyber-green hover:border-cyber-green';
                
                completionButtonHtml = `
                    <button type="button" id="btn-toggle-complete" class="flex-1 py-3 border ${completeClass} bg-transparent text-xs font-bold tracking-widest transition-colors flex items-center justify-center gap-2 group">
                        <i class="fas ${completeIcon} group-hover:scale-110 transition-transform"></i> ${completeLabel}
                    </button>
                `;
            }

            actions.innerHTML = `
                <button type="button" id="btn-delete-note" class="p-3 border border-cyber-red/30 text-cyber-red bg-cyber-red/5 hover:bg-cyber-red/10 transition-colors" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
                ${completionButtonHtml}
                <button type="button" id="btn-edit-mode" class="flex-1 py-3 bg-t-input text-t-text text-xs font-bold tracking-widest hover:bg-opacity-80 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-pen"></i> EDIT_DATA
                </button>
            `;
        }

        // --- RENDERERS ---

        function renderApp() {
            renderHeader();
            renderTabs();
            renderMemoryList();
        }

        function renderHeader() {
            const container = document.getElementById('header-container');
            
            if (STORE.isSearchOpen) {
                container.innerHTML = `
                    <header class="px-6 py-4 transition-colors duration-300 animate-in fade-in slide-in-from-top-2 duration-300">
                        <div class="flex items-center gap-3">
                             <div class="relative flex-1">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-cyber-blue"></i>
                                <input id="input-search" type="text" class="w-full bg-t-input border-b border-cyber-blue text-t-text font-sans text-sm py-2 pl-10 pr-4 focus:outline-none uppercase tracking-wide placeholder-gray-500" placeholder="SEARCH_MEMORY_BANKS..." value="${STORE.searchQuery}" autocomplete="off">
                             </div>
                             <button id="btn-close-search" class="text-t-muted hover:text-cyber-red transition-colors px-2">
                                <i class="fas fa-times"></i>
                             </button>
                        </div>
                    </header>
                `;
            } else {
                container.innerHTML = `
                    <header class="px-6 py-4 transition-colors duration-300 animate-in fade-in slide-in-from-top-2 duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <h1 class="font-tech text-xl font-bold tracking-widest text-t-text">NEXUS</h1>
                                <span class="text-[0.6rem] font-bold tracking-[0.2em] text-cyber-blue">ARCHIVE // v1.0</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- SYSTEM CLOCK -->
                                <div id="system-clock" class="hidden sm:block">00:00:00</div>
                                <div id="system-clock-mobile" class="sm:hidden text-cyber-blue font-mono text-xs tracking-wider font-bold">00:00:00</div>
                                
                                <div class="h-6 w-[1px] bg-cyber-blue/20"></div>

                                <!-- SEARCH BUTTON -->
                                 <button id="btn-toggle-search" class="btn-pill btn-action-search" title="Search">
                                    <i class="fas fa-search"></i>
                                    <span>SCAN</span>
                                 </button>
                                 
                                 <!-- SETTINGS BUTTON -->
                                 <button id="btn-open-settings" class="btn-pill btn-action-settings" title="Configuration">
                                    <i class="fas fa-cog"></i>
                                    <span>SYS</span>
                                 </button>
                            </div>
                        </div>
                    </header>
                `;
            }
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            const html = STORE.folders.map(f => `
                <button 
                    class="nav-tab whitespace-nowrap px-4 py-2 text-[0.65rem] font-bold tracking-widest uppercase transition-all duration-300 border-b-2 ${STORE.activeFolderId === f.id ? 'border-cyber-blue text-cyber-blue bg-cyber-blue/5' : 'border-transparent text-t-muted hover:text-t-text'}"
                    data-id="${f.id}"
                >
                    ${f.name}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="flex items-center px-4 py-1 overflow-x-auto scrollbar-hide gap-2">
                    ${html}
                    <button id="btn-add-folder" class="ml-2 p-2 text-cyber-blue hover:bg-cyber-blue/10 rounded transition-colors active:scale-95" title="Add New Partition">
                        <i class="fas fa-plus pointer-events-none text-xs"></i>
                    </button>
                </div>
            `;
        }

        function renderMemoryList() {
            const container = document.getElementById('main-content');
            
            // 0. Filter by Dock Mode (Text vs Chat)
            let filtered = STORE.memories;
            if (STORE.currentAppMode === 'text') {
                 // Show text notes (type='text' or undefined/null for legacy)
                 filtered = filtered.filter(m => !m.type || m.type === 'text');
            } else {
                 // Show chat notes
                 filtered = filtered.filter(m => m.type === 'chat');
            }

            // 1. Filter by Folder
            if (STORE.activeFolderId !== 'all') {
                filtered = filtered.filter(m => m.folderId === STORE.activeFolderId);
            }
            
            // 2. Filter by Search
            if (STORE.searchQuery) {
                const q = STORE.searchQuery.toLowerCase();
                filtered = filtered.filter(m => 
                    (m.title && m.title.toLowerCase().includes(q)) || 
                    (m.content && m.content.toLowerCase().includes(q))
                );
            }
            
            // Sort: Pinned first (True > False), then Last Updated (Desc)
            filtered.sort((a, b) => {
                if (a.isPinned === true && b.isPinned !== true) return -1;
                if (a.isPinned !== true && b.isPinned === true) return 1;
                return new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0);
            });

            // Header part (Context Aware)
            const countLabel = STORE.currentAppMode === 'text' ? 'MEMORY_STREAMS' : 'LINK_LOGS';

            let html = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xs font-bold tracking-[0.2em] text-t-muted">${countLabel} // ${filtered.length}</h2>
                    <div class="h-[1px] flex-1 bg-t-border ml-4 opacity-50"></div>
                </div>
                <div class="space-y-4 min-h-[50vh]">
            `;

            if (filtered.length === 0) {
                // Modified Empty State UI
                html += `
                    <div class="empty-state flex flex-col items-center justify-center h-[60vh] opacity-80">
                        <i class="fa-solid fa-cube fa-3x animate-pulse-fast" style="color: rgba(47, 180, 233, 0.3); margin-bottom: 20px;"></i>
                        <div style="font-family: 'Rajdhani'; letter-spacing: 2px; color: rgba(47, 180, 233, 0.5); font-weight: 600;">
                            // MEMORY BUFFER EMPTY
                        </div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">Awaiting User Input...</div>
                    </div>
                `;
            } else {
                html += filtered.map(m => {
                    // Find Folder Name
                    const folder = STORE.folders.find(f => f.id === m.folderId);
                    const folderName = folder ? folder.name : 'ALL';
                    const isPinned = !!m.isPinned;
                    const isChat = m.type === 'chat';
                    const isCompleted = !!m.isCompleted;
                    const isMission = !!m.isMission;
                    
                    // Format Date
                    const displayDate = m.lastUpdated ? formatCyberDate(m.lastUpdated) : (m.timestamp || 'UNKNOWN DATE');

                    // Content Preview Logic
                    let previewText = "";
                    if (isChat) {
                        try {
                            const history = JSON.parse(m.content);
                            // Find last user msg
                            const lastUserMsg = [...history].reverse().find(x => x.role === 'user');
                            previewText = lastUserMsg ? lastUserMsg.text : "No interaction data.";
                        } catch(e) {
                            previewText = "Data corruption.";
                        }
                    } else {
                        previewText = m.content;
                    }

                    // Card Styling based on Pin/Complete status
                    let borderClass = 'border-t-border hover:border-cyber-blue';
                    let hoverClass = 'hover:shadow-[0_0_20px_rgba(47,180,233,0.15)]';
                    let opacityClass = '';
                    let titleClass = 'text-t-text';

                    if (isPinned) {
                        borderClass = 'border-cyber-yellow shadow-[0_0_15px_rgba(243,200,69,0.15)]';
                        hoverClass = 'hover:shadow-[0_0_25px_rgba(243,200,69,0.3)]';
                    }
                    
                    // Completion style ONLY applies if it is also a mission
                    if (isMission && isCompleted) {
                        opacityClass = 'mission-completed';
                        titleClass = 'text-t-muted line-through-cyber';
                    }
                    
                    // Image Rendering for Card
                    const imageHtml = m.image ? `
                        <div class="w-full h-32 overflow-hidden mb-3 rounded-sm border-b border-cyber-blue/20 relative">
                            <img src="${m.image}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        </div>
                    ` : '';

                    return `
                    <div class="note-card group relative overflow-hidden rounded-sm border glass-panel p-5 cursor-pointer transition-all duration-300 ease-out hover:translate-x-1 active:scale-[0.98] ${borderClass} ${hoverClass} ${opacityClass}" data-id="${m.id}">
                        <!-- Decoration Corner -->
                        <div class="absolute top-0 right-0 w-0 h-0 border-l-[20px] border-l-transparent border-t-[20px] border-t-border group-hover:border-t-cyber-blue transition-colors duration-300"></div>
                        
                        <!-- System Badge (Folder) -->
                        <div class="absolute top-[10px] right-[10px] z-10 border border-cyber-blue/50 text-cyber-blue text-[10px] px-[6px] py-[2px] bg-cyber-blue/10 shadow-[0_0_5px_rgba(47,180,233,0.2)] font-bold uppercase tracking-widest font-tech rounded-sm backdrop-blur-sm">
                            ${folderName}
                        </div>
                        
                        <!-- Completed Badge (Only for Missions) -->
                        ${isMission && isCompleted ? '<div class="absolute top-[35px] right-[10px] z-10 text-cyber-green text-lg animate-fade-in"><i class="fas fa-check-circle"></i></div>' : ''}

                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-transparent group-hover:bg-cyber-blue transition-all duration-300"></div>
                        
                        <!-- Image -->
                        ${imageHtml}
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col pr-8 w-full">
                                <div class="flex items-center gap-2 mb-1">
                                    ${isPinned ? '<i class="fas fa-thumbtack text-cyber-yellow text-xs animate-pulse"></i>' : ''}
                                    ${isMission ? '<i class="fas fa-crosshairs text-cyber-red text-xs"></i>' : ''}
                                    <span class="text-[0.6rem] font-tech tracking-[0.2em] text-cyber-blue">${m.id.substring(0, 12)}</span>
                                </div>
                                <h3 class="font-tech text-lg font-bold tracking-wide break-words pr-2 line-clamp-1 mr-16 ${titleClass}">${m.title}</h3>
                            </div>
                        </div>
                        <p class="font-sans text-sm leading-relaxed pr-2 line-clamp-2 text-t-muted">${previewText}</p>
                        <div class="mt-4 flex justify-between items-end border-t border-t-border pt-2">
                            <span class="text-[0.55rem] font-bold text-gray-400 tracking-machine">${displayDate}</span>
                            <div class="flex gap-1 items-center">
                                <span class="h-1 w-1 bg-cyber-blue/30 rounded-full animate-pulse"></span>
                                <button class="btn-trash-card ml-2 text-t-muted hover:text-cyber-red transition-colors p-1" data-id="${m.id}">
                                    <i class="fas fa-trash text-xs pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            html += `</div>
                <div class="mt-8 flex justify-center opacity-30">
                    <span class="text-[0.5rem] tracking-[0.5em] text-gray-400">NEXUS // ARCHIVE</span>
                </div>
            `;

            container.innerHTML = html;
        }

    </script>
</body>
</html>